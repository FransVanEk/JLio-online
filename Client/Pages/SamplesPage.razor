@page "/samples"
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using System.Web
@using System.Threading
@implements IDisposable

@inject SamplesStore samplesstore
@inject IWebAssemblyHostEnvironment HostEnvironment
@inject IJSRuntime js
@inject NavigationManager NavigationManager

@if (isInitialized)
{
@if (HostEnvironment.Environment == "Development")
{
    <div class="row">
        <div class=" col-12">
            <RadzenButton ButtonType="ButtonType.Button" Icon="file_download" Click=@(args => Download()) style="width: 100%; margin-bottom: 3px;"/>
        </div>
    </div>
}
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-12 col-md-6 col-lg-4">
            <h4>Filter by Tag:</h4>
            <RadzenDropDown @bind-Value=@selectedTag TValue="string" Data="@tags" Change=@(args => OnFilterChange()) Style="width: 100%; max-width: 400px;" Placeholder="Select a tag..."/>
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-lg-3" style="margin-bottom: 20px;">
            <h5>Samples (@filteredSamples.Count)</h5>
            <RadzenListBox AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" @bind-Value=@selectedSampleTitle Data=@filteredSamples Change=@(OnChange) TextProperty="Title" ValueProperty="Title" Style="height: 500px; width: 100%;"/>
        </div>
        @if (selectedSample != null && selectedSample.Model != null)
        {
            <div class="col-12 col-lg-9">
                <div class="row">
                    <div class="col-12">
                        <h3>@selectedSample.Model.Name - @selectedSample.Title</h3>
                    </div>
                    <div class="col-12" style="max-width: 600px;">
                        @((MarkupString) @selectedSample.Description.Replace(Environment.NewLine, "<br />"))
                    </div>
                    <div class="col-12">
                        <h4>Script</h4>
                        <br/>
                        <JsonEditor ReadOnly="true" @ref="scriptEditor"/>
                    </div>

                    <div class="col-12">
                        @if (selectedSample != null)
                        {
                            <RadzenButton ButtonType="ButtonType.Button" Click=@(args => TryIt()) Icon="spellcheck" style="width: 100%; margin-bottom: 3px;" Text="Try it out in the editor"/>
                        }
                    </div>
                    <div class="col-12">
                        <h4>Changes</h4>
                        <br/>
                        <JsonDiff @bind-OriginalJson=@before @bind-ModifiedJson=@after @ref="jsonDiff"></JsonDiff>
                    </div>
                </div>
            </div>
        }
    </div>
}



@code {

    List<SampleMetadata> allMetadata = new List<SampleMetadata>();
    IEnumerable<string> tags { get; set; } = new List<string>();
    string selectedTag { get; set; } = string.Empty;
    string selectedSampleTitle { get; set; } = string.Empty;
    JsonEditor scriptEditor;
    JsonDiff jsonDiff;
    string before;
    string after;
    List<SampleMetadata> filteredSamples { get; set; } = new List<SampleMetadata>();
    Sample selectedSample { get; set; }
    bool isInitialized = false;
    private CancellationTokenSource _updateCancellation;

    async Task Download()
    {
        await samplesstore.GetSamples();
        var bytes = System.Text.Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(samplesstore.Samples, Formatting.Indented));
        await SaveAsFile.SaveAs(js, "samples.json", bytes);
    }

    protected override async Task OnInitializedAsync()
    {
        // Load only metadata first (1 HTTP request instead of 160+)
        allMetadata = await samplesstore.GetSampleMetadataAsync();
        tags = GetTags();
        selectedTag = "All"; // Set default to "All"
        filteredSamples = GetFilteredSamples();
        selectedSampleTitle = filteredSamples.FirstOrDefault()?.Title;
        isInitialized = true;
        // Load first sample after rendering
        await SetSelectedSample();
    }

    private List<string> GetTags()
    {
        var tagList = new List<string> { "All" };
        var sampleTags = allMetadata?.Where(s => s.Tags != null).SelectMany(s => s.Tags).Distinct().OrderBy(t => t).ToList();
        if (sampleTags != null)
        {
            tagList.AddRange(sampleTags);
        }
        return tagList;
    }

    private List<SampleMetadata> GetFilteredSamples()
    {
        if (string.IsNullOrWhiteSpace(selectedTag) || selectedTag == "All")
        {
            return allMetadata;
        }
        return allMetadata.Where(s => s.Tags.Contains(selectedTag)).ToList();
    }

    async Task OnFilterChange()
    {
        filteredSamples = GetFilteredSamples();
        if (filteredSamples.All(f => f.Title != selectedSampleTitle))
        {
            selectedSampleTitle = filteredSamples.FirstOrDefault()?.Title;
            await SetSelectedSample();
            await UpdateView();
        }
    }

    private async Task SetSelectedSample()
    {
        // Cancel any pending update
        _updateCancellation?.Cancel();
        _updateCancellation = new CancellationTokenSource();
        var cancellationToken = _updateCancellation.Token;
        
        // Load the specific sample on-demand
        var metadata = filteredSamples.FirstOrDefault(s => s.Title == selectedSampleTitle);
        if (metadata != null)
        {
            selectedSample = await samplesstore.GetSampleAsync(metadata.Number);
            StateHasChanged(); // Force re-render after loading
        }
        
        // Small delay to avoid rapid successive updates
        try
        {
            await Task.Delay(50, cancellationToken);
            if (!cancellationToken.IsCancellationRequested && selectedSample?.Model != null)
            {
                await UpdateView();
            }
        }
        catch (TaskCanceledException)
        {
            // Cancelled by new selection, ignore
        }
    }

    private async Task UpdateView()
    {
        if (selectedSample?.Model == null) { return; }
        
        try
        {
            // Unescape the script text for proper Monaco editor display
            var scriptText = selectedSample.Model.ScriptText?.Replace("\\r\\n", "\r\n").Replace("\\\"", "\"");
            scriptEditor?.Update(scriptText);
            after = JsonConvert.SerializeObject(ParseList(selectedSample.Model.OutputObjects), Formatting.Indented);
            before = JsonConvert.SerializeObject(ParseList(selectedSample.Model.InputObjects), Formatting.Indented);
            if (jsonDiff != null)
            {
                await jsonDiff?.Update(before, after);
            }
        }
        catch (Exception)
        {
            // Ignore disposed object errors when switching samples quickly
        }
    }


    JToken ParseList(List<JsonObjectViewModel> items)
    {
        if (items == null)
        {
            return JValue.CreateNull();

        }
        try
        {
            var collection = new Dictionary<string, JToken>();
            items.ForEach(i =>
            {
                collection.Add(i.Name, JToken.Parse(i.JsonString));
            });

            return collection.ConvertToDataObject();
        }
        catch (Exception)
        {
            // ignored
        }
        return new JObject();
    }

    async Task OnChange(object value)
    {
        selectedSampleTitle = value is IEnumerable<object> ? string.Join(", ", (IEnumerable<object>)value) : value.ToString();
        await SetSelectedSample();
    }

    public void TryIt()
    {
        if (selectedSample != null)
        {
            NavigationManager.NavigateTo($"/multipleInputEditor/{HttpUtility.UrlEncode(selectedSample.Title)}");
        }
    }

    public void Dispose()
    {
        _updateCancellation?.Cancel();
        _updateCancellation?.Dispose();
    }
}
